# CI運用ポリシー

## CIの目的

- コード品質の維持（lint、構文チェック）
- セキュリティチェック（機密情報の漏洩防止）
- 一貫性の確保（フォーマットチェック）

## ワークフロー

### 自動実行タイミング

- `push` イベント: mainブランチへのプッシュ時
- `pull_request` イベント: PR作成・更新時

### 実行されるチェック

1. **ShellCheck (Lint)**
   - シェルスクリプトのベストプラクティス違反を検出
   - 警告は許可（`|| true`）、エラーは失敗

2. **構文チェック**
   - `bash -n` で各スクリプトの構文を検証
   - 構文エラーがある場合はCI失敗

3. **フォーマットチェック (shfmt)**
   - コードフォーマットの一貫性を確認
   - 差分がある場合は警告

4. **セキュリティスキャン**
   - 機密情報（password, secret, api_key等）の検出
   - 誤検知を避けるため、特定のパターンは除外

## 失敗時の対応

### CIが失敗した場合

1. **ローカルで再現**
   ```bash
   make lint
   make test
   ```

2. **エラーを修正**
   - ShellCheckの警告/エラーを確認
   - 構文エラーを修正
   - フォーマットを統一: `make fmt`

3. **再コミット**
   ```bash
   git add .
   git commit -m "Fix: CIエラーを修正"
   git push
   ```

### よくある失敗パターン

#### ShellCheckエラー
```bash
# ローカルで確認
shellcheck script.sh

# 自動修正できない場合は手動で修正
```

#### 構文エラー
```bash
# 構文チェック
bash -n script.sh

# エラーメッセージを確認して修正
```

#### フォーマット差分
```bash
# 自動フォーマット
make fmt

# コミット
git add .
git commit -m "Format: shfmtでフォーマットを統一"
```

## 受け入れ基準

PRがマージ可能になる条件:

- ✅ すべてのCIチェックがパス
- ✅ レビュー承認（該当する場合）
- ✅ コンフリクトなし

## 注意事項

- CIは警告を許可しているため、警告だけでは失敗しない
- セキュリティスキャンは基本的なパターンマッチングのみ
- より厳密なチェックが必要な場合は、ローカルで `make lint` を実行

## トラブルシューティング

### CIが実行されない

- GitHub Actionsが有効になっているか確認
- ワークフローファイルが `.github/workflows/` に存在するか確認
- リポジトリのSettings → Actionsで確認

### 権限エラー

- GitHub CLIの認証スコープを確認: `gh auth status`
- 必要に応じて更新: `gh auth refresh -s workflow`

